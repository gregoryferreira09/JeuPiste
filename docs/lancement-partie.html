<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lancement de la Partie - Jeu de piste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/style.css">
  <style>
    body {
      background: #181212;
      color: #f4e4c1;
      font-family: 'Cormorant Garamond', serif;
    }
    header h1 {
      text-align: center;
      margin-top: 1.4em;
      font-family: 'Cinzel Decorative', serif;
      color: #e0c185;
    }
    .page-lancement {
      max-width: 600px;
      margin: 40px auto 24px auto;
    }
    .bandeau-principal {
      background: #2c1b1b;
      border-radius: 18px;
      box-shadow: 0 4px 20px #0002;
      padding: 32px 28px 20px 28px;
      border: 2px solid #e0c185;
      color: #f4e4c1;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.13em;
      margin-bottom: 40px;
      position: relative;
    }
    .bandeau-principal h2 {
      font-family: 'Cinzel Decorative', serif;
      color: #e9c78c;
      margin-bottom: 16px;
      font-size: 1.33em;
      text-align: center;
    }
    .actions-bandeau {
      display: flex;
      gap: 18px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 28px;
      margin-bottom: 8px;
    }
    .main-btn {
      background: #181212;
      color: #e0c185;
      border: 2px solid #e0c185;
      border-radius: 12px;
      margin: 0 auto;
      padding: 14px 22px;
      font-family: 'Cormorant Garamond', serif;
      box-shadow: 0 2px 20px #0004;
      font-size: 1.13em;
      transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.11s;
      cursor: pointer;
      font-weight: 600;
      outline: none;
    }
    .main-btn:focus, .main-btn:hover {
      background: #e0c185;
      color: #181212;
      box-shadow: 0 0 8px #e0c185a8;
      outline: 2px solid #e0c185;
      outline-offset: 3px;
      transform: scale(1.04);
    }
    .main-btn[disabled], .main-btn[style*="pointer-events: none"] {
      opacity: 0.6;
      pointer-events: none;
    }
    .info {
      font-size: .99em;
      color: #c9b49a;
      text-align: center;
      margin-top: 18px;
      margin-bottom: 4px;
    }
    @media (max-width: 700px) {
      .page-lancement, .bandeau-principal {
        max-width: 97vw; padding: 12px 2vw; border-radius: 12px; font-size: 1em;
      }
      .main-btn { width: 100%; min-width: 0; max-width: 99vw; font-size: 1em;}
      .actions-bandeau { flex-direction: column; gap: 10px;}
    }
    #confirmationRetourAccueil {
      display: none;
      position: fixed;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      background: rgba(24,18,18,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    #confirmationRetourAccueil .modal-content {
      background: #2c1b1b;
      border: 2px solid #e0c185;
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      color: #f4e4c1;
      box-shadow: 0 8px 32px #0007;
      min-width: 280px;
    }
    #confirmationRetourAccueil .modal-actions {
      margin-top: 24px;
      display: flex;
      justify-content: center;
      gap: 18px;
    }
    #confirmationRetourAccueil .main-btn {
      min-width: 80px;
    }
    #loader {
      display: none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(24,18,18,0.35);
      z-index: 99999;
      justify-content: center;
      align-items: center;
    }
    .spinner {
      border: 4px solid #eee;
      border-top: 4px solid #e0c185;
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-toast {
      display: none;
      position: fixed;
      left: 50%; top: 12%;
      transform: translateX(-50%);
      background: #231d1d;
      color: #ffeecb;
      border: 2px solid #e0c185;
      border-radius: 8px;
      padding: 16px 28px;
      font-size: 1.14em;
      z-index: 99999;
      box-shadow: 0 4px 22px #0006;
      text-align:center;
      max-width: 90vw;
    }
    .modal-toast.visible {
      display: block;
      animation: fadein 0.3s;
    }
    @keyframes fadein { from { opacity: 0; } to { opacity: 1; }}
  </style>
</head>
<body>
  <header>
    <h1 class="site-title">Lancement de la partie</h1>
  </header>
  <div class="center-wrapper">
    <main>
      <section class="page-lancement fadeIn" role="main" aria-live="polite">
        <div class="bandeau-principal">
          <div class="presentation-jeu">
            <div class="titre-course">Avalon</div>
            <div class="texte-course">
              Moi, Merlin l'Enchanteur, vous convoque pour la plus noble des aventures : la quête du Saint-Graal.<br>
              Les temps sont sombres, et seul les plus dignes des chevaliers parmi vous pourrez retrouver le Graal sacré, source de sagesse et de paix pour le royaume.
            </div>
            <div class="objectif-course">
              <span class="objectif-label">Objectif&nbsp;:</span>
              <span class="objectif-text">Rassemblez votre équipe, serrez les rangs… et courez, car les vents de la destinée soufflent sur votre route.</span>
            </div>
            <div class="regles-course">
              <strong>Règles du jeu&nbsp;:</strong><br>
              Six quêtes vous sont proposées pour prouver votre valeur de nobles chevaliers. Sans cela n'espérez pas atteindre l'antre du dragon et encore moins lui dérober ce qu'il détient depuis des siècles. L'entraide, la ruse et la rapidité feront la différence.
            </div>
          </div>
          <div class="actions-bandeau">
            <a class="main-btn" id="demarrerBtn" href="#" style="pointer-events:none; opacity:0.6;">Disponible dans 30s</a>
            <button class="main-btn" id="btnRetourAccueil">Retour accueil</button>
          </div>
          <div class="info" id="messageInfo"></div>
        </div>
      </section>
    </main>
  </div>
  <footer class="footer">
    <p>© 2025 Jeu de piste. Tous droits réservés.</p>
    <a href="mentions-legales.html">Mentions légales</a>
  </footer>

  <!-- Fenêtre flottante confirmation retour accueil -->
  <div id="confirmationRetourAccueil" role="dialog" aria-modal="true" aria-labelledby="confirmationTitle">
    <div class="modal-content">
      <div class="modal-question" id="confirmationTitle">
        Voulez-vous vraiment quitter la partie et revenir à l’accueil ?
      </div>
      <div class="modal-actions">
        <button id="confirmerRetourAccueilBtn" class="main-btn">Oui</button>
        <button id="annulerRetourAccueilBtn" class="main-btn">Non</button>
      </div>
    </div>
  </div>

  <!-- Loader visuel -->
  <div id="loader" aria-live="polite"><div class="spinner"></div></div>
  <!-- Toast feedback -->
  <div class="modal-toast" id="toast-message" role="alert" aria-live="assertive"></div>

  <!-- Firebase SDK (moderne) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // === CONFIG FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyD-BxBu-4ElCqbHrZPM-4-6yf1-yWnL1bI",
      authDomain: "murder-party-ba8d1.firebaseapp.com",
      databaseURL: "https://murder-party-ba8d1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "murder-party-ba8d1",
      storageBucket: "murder-party-ba8d1.firebasestorage.app",
      messagingSenderId: "20295055805",
      appId: "1:20295055805:web:0963719c3f23ab7752fad4",
      measurementId: "G-KSBMBB7KMJ"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // === FONCTIONS UTILITAIRES ===
    function showLoader() { document.getElementById('loader').style.display = 'flex'; }
    function hideLoader() { document.getElementById('loader').style.display = 'none'; }
    function showToast(msg) {
      const toast = document.getElementById('toast-message');
      toast.textContent = msg;
      toast.classList.add('visible');
      setTimeout(() => { toast.classList.remove('visible'); }, 2700);
    }

    // Effet fade-in
    document.addEventListener("DOMContentLoaded", function() {
      var section = document.querySelector('.fadeIn');
      if (section) section.classList.add('visible');
    });

    // Décompte visible du bouton Démarrer
    document.addEventListener("DOMContentLoaded", function() {
      const demarrerBtn = document.getElementById("demarrerBtn");
      let timer = 30;
      if (demarrerBtn) {
        demarrerBtn.textContent = "Disponible dans 30s";
        const interval = setInterval(() => {
          timer--;
          if (timer > 0) {
            demarrerBtn.textContent = `Disponible dans ${timer}s`;
          } else {
            clearInterval(interval);
            demarrerBtn.style.pointerEvents = "auto";
            demarrerBtn.style.opacity = "1";
            demarrerBtn.textContent = "Démarrer la partie";
            // Ajout: navigation propre, désactive la protection
            demarrerBtn.addEventListener("click", function(e) {
              e.preventDefault();
              if (window.disableBackProtection) window.disableBackProtection();
              window.location.href = "personnages.html";
            });
          }
        }, 1000);
      }
    });

    // Gestion de la modale de retour accueil
    document.addEventListener("DOMContentLoaded", function() {
      const btnRetour = document.getElementById("btnRetourAccueil");
      const confirmation = document.getElementById("confirmationRetourAccueil");
      const btnConfirmer = document.getElementById("confirmerRetourAccueilBtn");
      const btnAnnuler = document.getElementById("annulerRetourAccueilBtn");
      if (btnRetour && confirmation && btnConfirmer && btnAnnuler) {
        btnRetour.addEventListener("click", () => {
          confirmation.style.display = "flex";
          document.getElementById('confirmerRetourAccueilBtn').focus();
        });
        btnConfirmer.addEventListener("click", () => {
          if (window.disableBackProtection) window.disableBackProtection();
          window.location.href = "accueil.html";
        });
        btnAnnuler.addEventListener("click", () => {
          confirmation.style.display = "none";
          btnRetour.focus();
        });
      }
    });

    // === VERROUILLAGE NAVIGATION/FORCING ===
    document.addEventListener("DOMContentLoaded", function() {
      showLoader();
      const salonCode = localStorage.getItem("salonCode");
      const equipeNum = Number(localStorage.getItem("equipeNum"));
      if (!salonCode || isNaN(equipeNum) || equipeNum < 0) {
        hideLoader();
        if (window.disableBackProtection) window.disableBackProtection();
        window.location.href = "accueil.html";
        return;
      }
      db.ref('parties/' + salonCode + '/equipes/' + equipeNum + '/currentStep').on('value', function(snapshot) {
        hideLoader();
        const step = snapshot.val();
        if (step !== undefined && step !== null && step > 0) {
          db.ref('parties/' + salonCode + '/cheminsParEquipe/' + equipeNum).once('value', function(snapIdx) {
            const parcoursIdx = snapIdx.val();
            db.ref('parties/' + salonCode + '/parcoursEquipes/' + parcoursIdx).once('value', function(snapParcours) {
              const parcours = snapParcours.val() || [1,2,3,4,5];
              const target = parcours[step-1];
              if (window.disableBackProtection) window.disableBackProtection();
              if (target === 6) window.location.href = "epreuve6.html";
              else if (target === 7) window.location.href = "révélation.html";
              else window.location.href = `equipe${target}-a.html`;
            });
          });
        }
      });
    });

    // Optionnel : gestion du retour arrière (anti-back)
    window.addEventListener("pageshow", function(evt) {
      if (evt.persisted) {
        location.reload();
      }
    });
  </script>
  <!-- Protection anti-retour (retour navigateur/téléphone uniquement) -->
  <script src="JS/forbid-back.js"></script>
</body>
</html>
