<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"> <!-- Définit l'encodage des caractères pour le document -->
  <title>Choix de l'équipe</title> <!-- Titre de l'onglet -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Responsive design -->
  <link rel="stylesheet" href="../../Public/styles/style.css"> <!-- Feuille de styles externe -->
  <style>
    body { background: #181212; color: #f4e4c1; font-family: 'Cormorant Garamond', serif; } /* Style général */
    .center-wrapper { max-width: 780px; margin: 0 auto; } /* Centrage contenu */
    .galerie-equipes { display: flex; flex-wrap: wrap; justify-content: center; gap: 28px; margin-bottom: 30px; } /* Galerie équipes */
    .carte-equipe { background: #2c1b1b; border: 2.5px solid #e0c185; border-radius: 15px; width: 170px; min-height: 140px; display: flex; flex-direction: column; align-items: center; margin: 0 8px 8px 0; padding: 18px 12px; box-shadow: 0 4px 20px #0004; cursor: pointer; transition: box-shadow 0.2s, opacity 0.2s; text-align: center; }
    .carte-equipe.trop-pleine { opacity: 0.58; pointer-events: none; filter: grayscale(0.5);}
    .carte-equipe.selectionnee { border: 2.5px solid #4CAF50 !important; box-shadow: 0 0 10px #4CAF50;}
    .nom-equipe { color: #e0c185; font-weight: bold; font-size: 1.15em; margin-bottom: 8px; }
    .etat-equipe { color: #ffeecb; font-size: 1em; margin-bottom: 6px; }
    .liste-joueurs { font-size: 0.99em; color: #f4e4c1; min-height: 1.5em; margin-bottom: 3px; }
    .main-btn { background: #181212; color: #e0c185; border: 2px solid #e0c185; border-radius: 12px; margin: 20px auto 0 auto; padding: 14px 22px; font-family: 'Cormorant Garamond', serif; box-shadow: 0 2px 20px #0004; font-size: 1.13em; font-weight: 600; transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.11s; cursor: pointer; outline: none; display: block; }
    .main-btn:focus, .main-btn:hover { background: #e0c185; color: #181212; box-shadow: 0 0 8px #e0c185a8; outline: 2px solid #e0c185; outline-offset: 3px; transform: scale(1.04);}
    .bandeau-resultat { margin: 28px auto 0 auto; max-width: 400px; font-size: 1.25em; color: #e0c185; background: #2c1b1b; border: 2px solid #e0c185; border-radius: 10px; padding: 20px 18px; text-align: center; box-shadow: 0 4px 20px #0004;}
    .error-debug { background: #c00; color: #fff; font-weight: bold; padding: 10px; border-radius: 8px; margin: 20px auto; max-width: 500px; }
  </style>
</head>
<body>
  <header>
    <h1 class="site-title">Murder Party</h1> <!-- Titre principal affiché en haut -->
  </header>
  <div class="center-wrapper">
    <main class="main-accueil fadeIn" role="main">
      <h2 style="font-size:2em; color:#e0c185; margin-bottom:1.3em;">Choisissez votre équipe</h2> <!-- Sous-titre -->
      <section class="galerie-equipes" id="galerieEquipes">
        <!-- Les équipes seront générées ici dynamiquement en JS -->
      </section>
      <div id="bandeauResultat"></div> <!-- Zone pour afficher le bandeau de "tout le monde est prêt" -->
      <div id="debugError"></div> <!-- Zone pour afficher une erreur si besoin -->
      <button class="main-btn" id="btnRetourAccueil">Retour accueil</button> <!-- Bouton retour accueil -->
    </main>
  </div>
  <footer class="footer">
    <p>© 2025 Murder Party. Tous droits réservés.</p>
    <a href="mentions-legales.html">Mentions légales</a>
  </footer>
  <!-- Firebase SDK (pour connecter à la base de données) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    // --- Configuration Firebase (connexion à ton projet) ---
    const firebaseConfig = {
      apiKey: "AIzaSyD-BxBu-4ElCqbHrZPM-4-6yf1-yWnL1bI",
      authDomain: "murder-party-ba8d1.firebaseapp.com",
      databaseURL: "https://murder-party-ba8d1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "murder-party-ba8d1",
      storageBucket: "murder-party-ba8d1.appspot.com",
      messagingSenderId: "20295055805",
      appId: "1:20295055805:web:0963719c3f23ab7752fad4",
      measurementId: "G-KSBMBB7KMJ"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig); // Initialise Firebase si ce n'est pas déjà fait
    }
    const db = firebase.database(); // Récupère la référence à la base de données

    let equipesInfos = []; // Tableau pour stocker les infos sur les équipes (capacités, etc)
    let nbJoueursPartie = 2; // Valeur par défaut du nombre de joueurs
    let pseudo = localStorage.getItem("pseudo") || ""; // Récupère le pseudo depuis le stockage local
    while (!pseudo) {
      pseudo = prompt("Entrez votre pseudo :"); // Demande le pseudo si absent
      if (pseudo) localStorage.setItem("pseudo", pseudo); // Et le stocke
    }
    let salonCode = localStorage.getItem("salonCode"); // Récupère le code de la partie
    if (!salonCode) {
      alert("Code salon manquant."); // Si absent, alerte et retour à l'accueil
      window.location.href = "accueil.html";
    }

    // --- Initialisation principale asynchrone ---
    async function initEquipes() {
      try {
        // 1. Récupère les paramètres de la partie dans Firebase
        const paramSnap = await db.ref('parties/' + salonCode + '/parametres').once('value');
        const params = paramSnap.val() || {};
        nbJoueursPartie = Number(params.nombreJoueurs) || 2;
        if (!nbJoueursPartie || isNaN(nbJoueursPartie)) throw new Error("Paramètre 'nombreJoueurs' absent ou invalide");

        // 2. Calcule la structure des équipes selon le nombre de joueurs
        let nbEquipes = Math.floor(nbJoueursPartie / 2);
        equipesInfos = [];
        for (let i = 0; i < nbEquipes; i++) equipesInfos.push({ capacite: 2 }); // Ajoute des équipes de 2
        if (nbJoueursPartie % 2 !== 0) equipesInfos.push({ capacite: 3 });      // Dernière équipe de 3 si nombre impair

        // 3. Vérifie si /equipes existe, sinon le crée vide
        const eqSnap = await db.ref('parties/' + salonCode + '/equipes').once('value');
        if (!eqSnap.exists()) {
          let equipesInit = equipesInfos.map(() => []);
          await db.ref('parties/' + salonCode + '/equipes').set(equipesInit);
        }
        // 4. Met en place le listener sur /equipes pour affichage en temps réel
        db.ref('parties/' + salonCode + '/equipes').on('value', function(snapshot) {
          const equipes = snapshot.val() || equipesInfos.map(() => []);
          afficherEquipes(equipes);
        });
      } catch (err) {
        afficherErreur("Erreur d'initialisation : " + err.message); // Affiche l'erreur en cas de souci
      }
    }

    // Affiche une erreur dans la page (zone debugError)
    function afficherErreur(msg) {
      document.getElementById('debugError').innerHTML = '<div class="error-debug">' + msg + '</div>';
    }

    // Affichage dynamique des cartes équipes
    function afficherEquipes(equipes) {
      const galerie = document.getElementById("galerieEquipes");
      galerie.innerHTML = ""; // Vide la galerie
      let toutLeMondeAUneEquipe = false;
      let monEquipe = null;
      equipesInfos.forEach((info, i) => {
        const joueurs = equipes[i] || []; // Liste des joueurs dans l'équipe i
        const capacite = info.capacite;
        const estComplete = joueurs.length >= capacite;
        const estMoiDedans = joueurs.includes(pseudo);
        if (estMoiDedans) monEquipe = i;
        // Crée la carte de l'équipe
        const div = document.createElement("div");
        div.className = "carte-equipe" + (estComplete ? " trop-pleine" : "") + (estMoiDedans ? " selectionnee" : "");
        div.innerHTML = `
          <div class="nom-equipe">Équipe ${i + 1}</div>
          <div class="etat-equipe">${joueurs.length} / ${capacite}</div>
          <div class="liste-joueurs">${joueurs.map(j => `<div>${j}</div>`).join("")}</div>
        `;
        // Clique pour rejoindre ou quitter
        if (!estComplete && !estMoiDedans) {
          div.addEventListener("click", () => rejoindreEquipe(i));
        } else if (estMoiDedans) {
          div.addEventListener("click", quitterEquipe);
        }
        galerie.appendChild(div); // Ajoute la carte à la galerie
      });
      // Calcule si tout le monde a une équipe
      let totalInscrits = equipes.reduce((sum, arr) => sum + arr.length, 0);
      toutLeMondeAUneEquipe = (totalInscrits === nbJoueursPartie);

      // Affiche le bandeau si tous les joueurs sont répartis
      const bandeau = document.getElementById("bandeauResultat");
      if (toutLeMondeAUneEquipe) {
        bandeau.innerHTML = `<div class="bandeau-resultat">Tout le monde est prêt ! <br>La partie va commencer...</div>`;
      } else {
        bandeau.innerHTML = "";
      }
    }

    // Fonction pour rejoindre une équipe
    function rejoindreEquipe(idx) {
      db.ref('parties/' + salonCode + '/equipes').transaction(equipes => {
        equipes = equipes || equipesInfos.map(() => []);
        equipes = equipes.map(arr => arr.filter(j => j !== pseudo)); // Se retire des autres équipes
        if (equipes[idx].length < equipesInfos[idx].capacite) {
          equipes[idx].push(pseudo); // Ajoute à la nouvelle équipe
        }
        return equipes;
      });
    }

    // Fonction pour quitter son équipe
    function quitterEquipe() {
      db.ref('parties/' + salonCode + '/equipes').transaction(equipes => {
        equipes = equipes || equipesInfos.map(() => []);
        equipes = equipes.map(arr => arr.filter(j => j !== pseudo));
        return equipes;
      });
    }

    // Clique sur "Retour accueil"
    document.getElementById("btnRetourAccueil").onclick = function() {
      window.location.href = "accueil.html"; // Redirige vers l'accueil
    };

    // Lance l'initialisation quand la page est chargée
    initEquipes();
  </script>
</body>
</html>
