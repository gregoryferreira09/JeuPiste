<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Choix de l'équipe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../Public/styles/style.css">
  <style>
    .galerie-equipes { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
    .carte-equipe { background-color: #2c1b1b; border: 2px solid #e9c78c; border-radius: 12px; width: 200px; padding: 20px 10px 10px 10px; text-align: center; cursor: pointer; transition: transform 0.3s ease; min-height: 100px; }
    .carte-equipe:hover { transform: scale(1.05); }
    .carte-equipe.indisponible { filter: grayscale(0.8) blur(1px); pointer-events: none; opacity: 0.7; }
    .carte-equipe.selectionnee { border: 2px solid #4CAF50 !important; }
    .nom-equipe { font-size:1em; color:#ffeecb; margin-bottom:7px; }
    .pseudos-equipe { font-size: 1.1em; color: #e0c185; margin-top: 12px; min-height: 25px; }
    #confirmationRetourAccueil { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(44,27,27,0.72); z-index:99999; justify-content:center; align-items:center; }
    #confirmationRetourAccueil .modal-content { max-width:340px; margin:auto; text-align:center; border:2.5px solid #e0c185; background:#2c1b1b; border-radius:18px; box-shadow:0 4px 20px #0009; padding:32px 28px; }
    #confirmationRetourAccueil .modal-content .modal-question { font-weight:bold; margin-bottom:22px; color:#e0c185; font-family:'Cinzel Decorative',serif; font-size:1.1em; }
    #confirmationRetourAccueil .modal-content .modal-actions { display:flex; flex-direction:row; gap:24px; justify-content:center; margin:0; }
    #confirmerRetourAccueilBtn { background:#e0c185; color:#181212; border:2px solid #e0c185; }
    #confirmerRetourAccueilBtn:hover { background:#ffeecb; color:#181212; border:2px solid #e0c185; }
    #annulerRetourAccueilBtn { background:transparent; color:#ffeecb; border:2px solid #e0c185; }
    #annulerRetourAccueilBtn:hover { background:#e0c185; color:#181212; border:2px solid #e0c185; }
    @media (max-width: 700px) { #confirmationRetourAccueil .modal-content {max-width:98vw;} }
    /* Loader */
    #loader { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(24,18,18,0.35); z-index: 99999; justify-content: center; align-items: center; }
    .spinner { border: 4px solid #eee; border-top: 4px solid #e0c185; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-toast { display: none; position: fixed; left: 50%; top: 12%; transform: translateX(-50%); background: #231d1d; color: #ffeecb; border: 2px solid #e0c185; border-radius: 8px; padding: 16px 28px; font-size: 1.14em; z-index: 99999; box-shadow: 0 4px 22px #0006; text-align:center; max-width: 90vw; }
    .modal-toast.visible { display: block; animation: fadein 0.3s; }
    @keyframes fadein { from { opacity: 0; } to { opacity: 1; }}
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // CONFIG FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyD-BxBu-4ElCqbHrZPM-4-6yf1-yWnL1bI",
      authDomain: "murder-party-ba8d1.firebaseapp.com",
      databaseURL: "https://murder-party-ba8d1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "murder-party-ba8d1",
      storageBucket: "murder-party-ba8d1.firebasestorage.app",
      messagingSenderId: "20295055805",
      appId: "1:20295055805:web:0963719c3f23ab7752fad4",
      measurementId: "G-KSBMBB7KMJ"
    };
    if (!window.firebase?.apps?.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Loader & Toast
    function showLoader() { document.getElementById('loader').style.display = 'flex'; }
    function hideLoader() { document.getElementById('loader').style.display = 'none'; }
    function showToast(msg) {
      const toast = document.getElementById('toast-message');
      toast.textContent = msg;
      toast.classList.add('visible');
      setTimeout(() => { toast.classList.remove('visible'); }, 2700);
    }

    // SECURISATION NAVIGATION (par currentStep)
    document.addEventListener("DOMContentLoaded", function() {
      showLoader();
      const salonCode = localStorage.getItem("salonCode");
      const equipeNum = Number(localStorage.getItem("equipeNum"));
      if (!salonCode) {
        hideLoader();
        window.location.href = "accueil.html";
        return;
      }
      // La page de choix d'équipe doit être accessible uniquement si currentStep == 0 (adapté selon ton flow)
      db.ref('parties/' + salonCode + '/equipes/' + equipeNum + '/currentStep').on('value', function(snapshot) {
        hideLoader();
        const step = snapshot.val();
        if (step !== undefined && step !== null && step > 0) {
          // On va à la bonne épreuve selon le parcours
          db.ref('parties/' + salonCode + '/cheminsParEquipe/' + equipeNum).once('value', function(snapIdx) {
            const parcoursIdx = snapIdx.val();
            db.ref('parties/' + salonCode + '/parcoursEquipes/' + parcoursIdx).once('value', function(snapParcours) {
              const parcours = snapParcours.val() || [1,2,3,4,5];
              const target = parcours[step-1];
              if (target === 6) window.location.href = "epreuve6.html";
              else if (target === 7) window.location.href = "révélation.html";
              else window.location.href = `equipe${target}-a.html`;
            });
          });
        }
        // Si step == 0 (choix d'équipe), on reste ici.
      });
    });

    // Anti retour arrière (optionnel)
    window.addEventListener("pageshow", function(evt) {
      if (evt.persisted) location.reload();
    });
  </script>
</head>
<body>
  <div id="loader" aria-live="polite"><div class="spinner"></div></div>
  <div class="modal-toast" id="toast-message" role="alert" aria-live="assertive"></div>
  <header>
    <h1 class="site-title">Jeu de piste</h1>
  </header>
  <div class="center-wrapper">
    <main class="main-accueil fadeIn" role="main">
      <h2 style="font-size:2em; color:#e0c185; margin-bottom:1.3em;">Choisissez votre équipe</h2>
      <section class="galerie-equipes" id="galerieEquipes">
        <!-- Les équipes seront ajoutées dynamiquement ici -->
      </section>
      <div class="boutons-actions">
        <button id="valider-choix" class="main-btn" disabled>Valider mon équipe</button>
        <button class="main-btn" id="btnRetourAccueil">Retour accueil</button>
      </div>
    </main>
  </div>
  <footer class="footer">
    <p>© 2025 Jeu de piste. Tous droits réservés.</p>
    <a href="mentions-legales.html">Mentions légales</a>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var main = document.querySelector('.fadeIn');
      if (main) main.classList.add('visible');
    });
    // ... (Le reste de ton JS de gestion des équipes reste inchangé)
    // Place ici tout ton code JS équipes déjà présent dans la page d'origine (voir message précédent)
  </script>
  <!-- Fenêtre flottante confirmation retour accueil -->
  <div id="confirmationRetourAccueil" role="dialog" aria-modal="true" aria-labelledby="confirmationTitle">
    <div class="modal-content">
      <div class="modal-question" id="confirmationTitle">
        Voulez-vous vraiment quitter la partie et revenir à l’accueil ?
      </div>
      <div class="modal-actions">
        <button id="confirmerRetourAccueilBtn" class="main-btn">Oui</button>
        <button id="annulerRetourAccueilBtn" class="main-btn">Non</button>
      </div>
    </div>
  </div>
</body>
</html>
