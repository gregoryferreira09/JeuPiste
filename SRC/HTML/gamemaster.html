<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gamemaster - Suivi des équipes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../Public/styles/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Style harmonisé */
    .main-accueil {
      max-width: 600px;
      margin: 38px auto;
      background: #2c1b1b;
      border-radius: 18px;
      box-shadow: 0 4px 20px #0001;
      padding: 32px 24px;
      border: 2px solid #e0c185;
      color: #f4e4c1;
      font-family: 'Cormorant Garamond', serif;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      min-width: 300px;
    }
    .main-accueil h1 {
      text-align: center;
      font-family: 'Cinzel Decorative', serif;
      font-size: 2.15em;
      margin-bottom: 18px;
      color: #e0c185;
      margin-top: 0;
    }
    .carousel {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      margin: 0 auto;
    }
    .carte-equipe {
      background: #231d1d;
      border: 2px solid #e0c185;
      border-radius: 14px;
      box-shadow: 0 2px 8px #0002;
      padding: 30px 18px 24px 18px;
      min-width: 260px;
      max-width: 410px;
      flex: 1 1 0;
      margin: 0 8px;
      color: #ffeecb;
      font-size: 1.05em;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .team-title {
      font-family: 'Cinzel Decorative', serif;
      color: #e0c185;
      font-size: 1.28em;
      text-align: center;
      margin-bottom: 8px;
      letter-spacing: 1px;
    }
    .team-members {
      color: #ffeecb;
      font-size: 1.08em;
      text-align: center;
      margin-bottom: 10px;
    }
    .etape-encours {
      color: #e9c78c;
      background: #291d10;
      border-radius: 7px;
      padding: 6px 0;
      font-weight: bold;
      margin: 10px 0 12px 0;
      text-align: center;
      font-size: 1.08em;
    }
    .timer {
      color: #ffeecb;
      text-align: center;
      margin: 9px 0 16px 0;
      font-size: 1.04em;
      font-family: 'Roboto Mono', monospace;
      background: #241b14;
      border-radius: 7px;
      padding: 8px 0;
    }
    .late { color: #ffadad !important; }
    .parcours-list {
      margin-top: 8px;
    }
    .epreuve {
      margin-bottom: 14px;
      padding-bottom: 6px;
      border-bottom: 1px dashed #e0c18544;
    }
    .epreuve:last-child { border-bottom: none; }
    .epreuve-titre {
      color: #e0c185;
      font-weight: bold;
      font-size: 1.06em;
      margin-bottom: 4px;
    }
    .fichiers-epreuve {
      color: #b8b8b8;
      font-size: 0.96em;
      margin-bottom: 2px;
    }
    .download-btn {
      background: #e0c185;
      color: #473714;
      border: none;
      border-radius: 7px;
      padding: 4px 16px;
      font-size: 0.98em;
      cursor: pointer;
      margin-left: 7px;
      margin-top: 4px;
      transition: background 0.2s;
    }
    .download-btn:hover, .download-btn:focus {
      background: #ffeecb;
      color: #473714;
      outline: 2px solid #e0c185;
    }
    .chrono-value {
      color: #ffe07e;
      font-size: 0.98em;
      font-weight: bold;
      margin-left: 8px;
      letter-spacing: 1px;
      font-family: 'Roboto Mono', monospace;
    }
    .nav-btn {
      background: linear-gradient(90deg, #e9c78c, #e0c185 60%);
      color: #473714;
      border: 2px solid #e0c185;
      border-radius: 8px;
      font-size: 1.5em;
      font-family: 'Cinzel Decorative', serif;
      font-weight: bold;
      padding: 8px 18px;
      cursor: pointer;
      margin: 0 4px;
      transition: box-shadow .2s, background .2s, color .2s;
      min-width: 54px;
      min-height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .nav-btn:hover, .nav-btn:focus {
      background: #e0c185;
      color: #1a1a1a;
      box-shadow: 0 0 8px #e0c18588;
      outline: 2px solid #e0c185;
    }
    @media (max-width: 750px) {
      .main-accueil { max-width: 97vw; padding: 10px 1vw; }
      .carte-equipe { min-width: 0; max-width: 99vw; padding: 20px 4vw; }
      .carousel { flex-direction: column; gap: 12px; }
      .nav-btn { min-width: 46px; min-height: 46px; font-size: 1.1em; padding: 7px 9px;}
    }
    body { background: #1b1b1b; }
  </style>
</head>
<body>
  <header>
    <div style="height: 22px;"></div>
  </header>
  <div class="center-wrapper">
    <main class="main-accueil" role="main">
      <h1>Gamemaster — Suivi des équipes</h1>
      <div class="carousel">
        <button class="nav-btn" id="prev-team" aria-label="Équipe précédente">&#8592;</button>
        <div class="carte-equipe" id="carte-equipe">
          <div style="text-align:center;">Chargement…</div>
        </div>
        <button class="nav-btn" id="next-team" aria-label="Équipe suivante">&#8594;</button>
      </div>
    </main>
  </div>
  <footer class="footer">
    <p>© 2025 Jeu de piste. Tous droits réservés.</p>
    <a href="mentions-legales.html">Mentions légales</a>
  </footer>
  <!-- JS inchangé -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    // --- CONFIG & INIT ---
    const firebaseConfig = {
      apiKey: "AIzaSyD-BxBu-4ElCqbHrZPM-4-6yf1-yWnL1bI",
      authDomain: "murder-party-ba8d1.firebaseapp.com",
      databaseURL: "https://murder-party-ba8d1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "murder-party-ba8d1",
      storageBucket: "murder-party-ba8d1.appspot.com",
      messagingSenderId: "20295055805",
      appId: "1:20295055805:web:0963719c3f23ab7752fad4",
      measurementId: "G-KSBMBB7KMJ"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const salonCode = localStorage.getItem("salonCode") || prompt("Code salon à superviser ?");
    let equipes = [];
    let nomsEquipes = {};
    let currentIndex = 0;
    let stepsTime = {};

    let etapes = [
      { titre: "Épreuve 1", fichiersAttendus: ["Photo 1"] },
      { titre: "Épreuve 2", fichiersAttendus: ["Vidéo"] },
      { titre: "Épreuve 3", fichiersAttendus: ["Photo 2"] },
      { titre: "Épreuve 4", fichiersAttendus: [] },
      { titre: "Épreuve 5", fichiersAttendus: [] },
      { titre: "Épreuve 6", fichiersAttendus: [] }
    ];

    document.getElementById('prev-team').onclick = function() {
      if (equipes.length) {
        currentIndex = (currentIndex - 1 + equipes.length) % equipes.length;
        chargerStepsTimeEtAfficher();
      }
    };
    document.getElementById('next-team').onclick = function() {
      if (equipes.length) {
        currentIndex = (currentIndex + 1) % equipes.length;
        chargerStepsTimeEtAfficher();
      }
    };

    function chargerEquipes(callback) {
      db.ref(`parties/${salonCode}/equipes`).once('value', snap => {
        const data = snap.val() || {};
        equipes = Object.entries(data).map(([num, eq]) => ({...eq, num}));
        db.ref(`parties/${salonCode}/nomsEquipes`).once('value', snapNoms => {
          nomsEquipes = snapNoms.val() || {};
          callback && callback();
        });
      });
    }

    function chargerStepsTimeEtAfficher() {
      if (equipes.length === 0) {
        document.getElementById('carte-equipe').innerHTML = "<div style='text-align:center;'>Aucune équipe détectée</div>";
        return;
      }
      const equipe = equipes[currentIndex];
      db.ref(`parties/${salonCode}/equipes/${equipe.num}/stepsTime`).once('value', snapStepsTime => {
        stepsTime = snapStepsTime.val() || {};
        afficherEquipe();
      });
    }

    function afficherEquipe() {
      const carte = document.getElementById('carte-equipe');
      const equipe = equipes[currentIndex];
      const nom = nomsEquipes[equipe.num] || `Équipe ${parseInt(equipe.num)+1}`;
      const membres = equipe.membres ? Object.values(equipe.membres).map(m=>m.pseudo).join(', ') : '—';
      const step = equipe.currentStep ?? 0;
      let html = `
        <div class='team-title'>${nom}</div>
        <div class='team-members'>${membres}</div>
        <div class='etape-encours'>Étape actuelle : <span>${etapes[step]?.titre || 'Terminé'}</span></div>
        <div id="timer" class="timer">Temps sur cette épreuve : 0:00</div>
        <div class='parcours-list'>
      `;

      for (let i=0; i<etapes.length; i++) {
        let statut = "";
        let chrono = "";
        if (i == step) {
          statut = " <span style='color:#ffe07e;'>(en cours)</span>";
        } else if (i < step) {
          let t = stepsTime && (stepsTime[i] !== undefined && stepsTime[i] !== null) ? stepsTime[i] : null;
          if (t !== null) {
            let min = Math.floor(t/60), sec = t%60;
            chrono = `<span class="chrono-value">(${min}:${sec.toString().padStart(2, '0')})</span>`;
          }
          statut = ` <span style='color:#a8ffb9;'>(réalisée)</span> ${chrono}`;
        }
        html += `<div class='epreuve'>
          <div class='epreuve-titre'>${etapes[i].titre}${statut}</div>
          <div class='fichiers-epreuve' id='fichiers-eq${equipe.num}-etape${i}'><span style='color:#b8b8b8;'>Chargement fichiers…</span></div>
        </div>`;
      }
      html += '</div>';
      carte.innerHTML = html;
      afficherTimer();
      for (let i=0; i<etapes.length; i++) {
        listerFichiersEquipeEtape(equipe.num, i, etapes[i].fichiersAttendus);
      }
    }

    // --- TIMER : Chrono en temps réel basé sur le startTime Firebase de l'étape courante ---
    let timerInterval = null;
    function afficherTimer() {
      if (timerInterval) clearInterval(timerInterval);
      const timerDiv = document.getElementById('timer');
      const equipe = equipes[currentIndex];
      const step = equipe.currentStep ?? 0;

      function maj() {
        if (step >= etapes.length) {
          timerDiv.textContent = "Temps sur cette épreuve : terminé";
          timerDiv.classList.remove('late');
          return;
        }
        db.ref(`parties/${salonCode}/equipes/${equipe.num}/epreuves/${step}/startTime`).once('value', snap => {
          const startTime = snap.val();
          if (!startTime) {
            timerDiv.textContent = "Temps sur cette épreuve : —";
            timerDiv.classList.remove('late');
            return;
          }
          const chronoVal = stepsTime && (stepsTime[step] !== undefined && stepsTime[step] !== null) ? stepsTime[step] : null;
          if (chronoVal !== null) {
            let min = Math.floor(chronoVal/60), sec = chronoVal%60;
            timerDiv.textContent = `Temps sur cette épreuve : ${min}:${sec.toString().padStart(2,'0')}`;
            timerDiv.classList.remove('late');
            return;
          }
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const min = Math.floor(elapsed/60), sec = elapsed%60;
          timerDiv.textContent = `Temps sur cette épreuve : ${min}:${sec.toString().padStart(2,'0')}`;
          if (elapsed >= 600) {
            timerDiv.classList.add('late');
            timerDiv.textContent += " ⏰";
          } else {
            timerDiv.classList.remove('late');
          }
        });
      }
      maj();
      timerInterval = setInterval(maj, 1000);
    }

    function listerFichiersEquipeEtape(num, etapeIdx, fichiersAttendus) {
      const div = document.getElementById(`fichiers-eq${num}-etape${etapeIdx}`);
      if (!div) return;
      const basePath = `parties/${salonCode}/equipe${num}/etape${etapeIdx}/`;
      storage.ref(basePath).listAll().then(res => {
        if (res.items.length === 0) {
          div.innerHTML = fichiersAttendus.map(nom=> `<div class="fichier-bloc"><span>${nom} :</span> <span style="color:#b8b8b8;">Non envoyé</span></div>`).join('');
        } else {
          div.innerHTML = '';
          fichiersAttendus.forEach(nomAttendu => {
            const fichier = res.items.find(item => item.name.toLowerCase().includes(nomAttendu.toLowerCase().replace(/\s/g,'')));
            if (!fichier) {
              div.innerHTML += `<div class="fichier-bloc"><span>${nomAttendu} :</span> <span style="color:#b8b8b8;">Non envoyé</span></div>`;
            } else {
              fichier.getDownloadURL().then(url => {
                const ext = fichier.name.split('.').pop().toLowerCase();
                let mini = '';
                if(['jpg','jpeg','png','gif'].includes(ext)) {
                  mini = `<img src="${url}" class="miniature" alt="Photo">`;
                } else if(['mp4','webm','ogg'].includes(ext)) {
                  mini = `<video src="${url}" class="miniature-video" muted preload="metadata" controls style="background:#181212;"></video>`;
                }
                div.innerHTML += `<div class="fichier-bloc">${mini}<span>${fichier.name}</span>
                  <button class="download-btn" onclick="downloadFile('${url}','${fichier.name}')">Télécharger</button></div>`;
              });
            }
          });
        }
      }).catch(()=>{div.innerHTML = "<span style='color:#b8b8b8;'>Erreur</span>";});
    }

    window.downloadFile = function(url, fileName) {
      fetch(url)
        .then(resp => resp.blob())
        .then(blob => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
          }, 100);
        });
    };

    function refreshLoop() {
      chargerEquipes(() => chargerStepsTimeEtAfficher());
      setTimeout(refreshLoop, 5000);
    }
    refreshLoop();
  </script>
</body>
</html>
