<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gamemaster - Jeu de Piste</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    #auth-section { margin: 2em 0; }
    #gm-content { display: none; }
    .tab-btn { padding: 0.5em 1em; margin-right: 1em; cursor: pointer; }
    .tab-btn.active { background: #007bff; color: #fff; }
    .cross { color: red; font-weight: bold; cursor: pointer; }
    table { border-collapse: collapse; margin: 1em 0; }
    th, td { border: 1px solid #ccc; padding: 0.3em 0.7em; }
  </style>
</head>
<body>
  <h1>Gamemaster : Interface de suivi</h1>
  <!-- Auth section -->
  <div id="auth-section">
    <input type="email" id="gm-email" placeholder="Email du gamemaster" required>
    <input type="password" id="gm-password" placeholder="Mot de passe" required>
    <button id="gm-login">Connexion Gamemaster</button>
    <div id="gm-auth-error" style="color:red;"></div>
  </div>

  <!-- Contenu réservé au gamemaster -->
  <div id="gm-content">
    <div>
      <button class="tab-btn active" id="btn-courante" onclick="afficherSuivi()">Partie en cours</button>
      <button class="tab-btn" id="btn-historique" onclick="afficherHistorique()">Historique</button>
    </div>
    <!-- Suivi partie en cours -->
    <div id="suivi-partie"></div>
    <!-- Historique -->
    <div id="historique-parties" style="display:none"></div>
  </div>

  <script>
    // --- CONFIGURATION FIREBASE ---
    var firebaseConfig = {
      apiKey: "AIzaSyD-BxBu-4ElCqbHrZPM-4-6yf1-yWnL1bI",
      authDomain: "murder-party-ba8d1.firebaseapp.com",
      databaseURL: "https://murder-party-ba8d1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "murder-party-ba8d1",
      storageBucket: "murder-party-ba8d1.appspot.com",
      messagingSenderId: "20295055805",
      appId: "1:20295055805:web:0963719c3f23ab7752fad4",
      measurementId: "G-KSBMBB7KMJ"
    };
    firebase.initializeApp(firebaseConfig);

    // --- AUTHENTIFICATION GAMEMASTER ---
    document.getElementById('gm-login').onclick = function() {
      const email = document.getElementById('gm-email').value;
      const pass = document.getElementById('gm-password').value;
      firebase.auth().signInWithEmailAndPassword(email, pass)
        .then(() => {
          document.getElementById('gm-auth-error').textContent = "";
        })
        .catch(e => {
          document.getElementById('gm-auth-error').textContent = "Connexion échouée : " + e.message;
        });
    };

    // Bloque/débloque l'accès selon l'état d'authentification
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        document.getElementById('auth-section').style.display = "none";
        document.getElementById('gm-content').style.display = "block";
        afficherSuivi(); // Affiche la partie en cours par défaut
      } else {
        document.getElementById('auth-section').style.display = "block";
        document.getElementById('gm-content').style.display = "none";
      }
    });

    // --- Onglets ---
    function afficherSuivi() {
      document.getElementById('suivi-partie').style.display = 'block';
      document.getElementById('historique-parties').style.display = 'none';
      document.getElementById('btn-courante').classList.add('active');
      document.getElementById('btn-historique').classList.remove('active');
      chargerPartieEnCours();
    }
    function afficherHistorique() {
      document.getElementById('suivi-partie').style.display = 'none';
      document.getElementById('historique-parties').style.display = 'block';
      document.getElementById('btn-courante').classList.remove('active');
      document.getElementById('btn-historique').classList.add('active');
      chargerHistorique();
    }

    // --- Partie en cours (la plus récente, par clé la plus haute) ---
    function chargerPartieEnCours() {
      const div = document.getElementById('suivi-partie');
      div.innerHTML = "<em>Chargement en cours...</em>";
      firebase.database().ref("parties").orderByKey().limitToLast(1).once("value").then(snap => {
        if (!snap.exists()) {
          div.innerHTML = "<em>Aucune partie en cours !</em>";
          return;
        }
        snap.forEach(partieSnap => {
          let partieId = partieSnap.key;
          let data = partieSnap.val();
          let html = `<h3>Partie en cours : <span style='color:#007bff'>${partieId}</span></h3>`;
          if (data.equipes && Object.keys(data.equipes).length > 0) {
            html += "<ul>";
            Object.entries(data.equipes).forEach(([eqId, eqData]) => {
              if (eqId !== "0" && eqData) {
                html += `<li><strong>Équipe ${eqId}</strong> — Avancement : ${eqData.etapeActuelle || 0}</li>`;
              }
            });
            html += "</ul>";
          } else {
            html += "<em>Aucune équipe enregistrée pour cette partie.</em>";
          }
          div.innerHTML = html;
        });
      }).catch(e => {
        div.innerHTML = "<span style='color:red'>Erreur lors du chargement : " + e.message + "</span>";
      });
    }

    // --- Historique ---
    function chargerHistorique() {
      const div = document.getElementById('historique-parties');
      div.innerHTML = "<em>Chargement en cours...</em>";
      firebase.database().ref("parties").once("value").then(snap => {
        if (!snap.exists()) {
          div.innerHTML = "<em>Aucune partie enregistrée.</em>";
          return;
        }
        let html = "<h3>Historique des parties</h3><table><tr><th>Partie</th><th>Supprimer</th></tr>";
        snap.forEach(partieSnap => {
          let partieId = partieSnap.key;
          html += `<tr id="ligne-${partieId}">
            <td>${partieId}</td>
            <td><span class="cross" onclick="supprimerPartie('${partieId}')">❌</span></td>
          </tr>`;
        });
        html += "</table>";
        div.innerHTML = html;
      }).catch(e => {
        div.innerHTML = "<span style='color:red'>Erreur lors du chargement : " + e.message + "</span>";
      });
    }

    // --- Suppression d'une partie ---
    function supprimerPartie(partieId) {
      if (confirm("Supprimer cette partie ?")) {
        firebase.database().ref("parties/"+partieId).remove().then(() => {
          const ligne = document.getElementById('ligne-'+partieId);
          if (ligne) ligne.remove();
        });
      }
    }
    // --- Pour compatibilité globale (onclick inline) ---
    window.supprimerPartie = supprimerPartie;
  </script>
</body>
</html>
