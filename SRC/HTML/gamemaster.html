<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gamemaster – Jeu de Piste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../Public/styles/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative&family=Cormorant+Garamond&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cormorant Garamond', serif;
      background: #2c1b1b;
      margin: 0;
      color: #f4e4c1;
    }
    .main-gamemaster {
      max-width: 560px;
      margin: 40px auto;
      background: #2c1b1b;
      border-radius: 18px;
      box-shadow: 0 4px 20px #0001;
      padding: 32px 28px;
      border: 2px solid #e0c185;
      color: #f4e4c1;
      font-family: 'Cormorant Garamond', serif;
    }
    .main-gamemaster h1 {
      text-align: center;
      font-family: 'Cinzel Decorative', serif;
      font-size: 2.1em;
      margin-bottom: 6px;
      color: #e0c185;
    }
    .main-gamemaster h2 {
      text-align: center;
      font-size: 1.18em;
      font-weight: 400;
      color: #f4e4c1;
      margin-top: 0;
      margin-bottom: 16px;
    }
    .gm-section {
      margin: 22px 0;
    }
    .gm-label {
      display: block;
      margin-bottom: 7px;
      color: #e0c185;
    }
    .gm-input, .gm-btn, .main-btn {
      font-family: inherit;
      border-radius: 7px;
      border: 2px solid #e0c185;
      font-size: 1em;
      padding: 11px 16px;
      margin-bottom: 10px;
      background: #281813;
      color: #f4e4c1;
      transition: background .15s, color .15s, border .15s;
      box-sizing: border-box;
    }
    .gm-input:focus, .gm-btn:focus, .main-btn:focus {
      outline: 2px solid #e0c185;
    }
    .gm-btn, .main-btn {
      cursor: pointer;
      margin-top: 10px;
      background: linear-gradient(90deg, #e9c78c, #e0c185 60%);
      color: #3d2b1f;
      border: 2px solid #e0c185;
      font-family: 'Cinzel Decorative', cursive;
      font-size: 1.07em;
      font-weight: bold;
      min-width: 130px;
      margin-bottom: 0;
    }
    .gm-btn:hover, .main-btn:hover {
      background: #e0c185;
      color: #1a1a1a;
      box-shadow: 0 0 8px #e0c18588;
    }
    .gm-error {
      color: #ff9393;
      margin-top: 6px;
      min-height: 22px;
      text-align: center;
    }
    .gm-tabs {
      display: flex;
      gap: 16px;
      margin-bottom: 18px;
      justify-content: center;
    }
    .gm-tab-btn {
      background: #2c1b1b;
      color: #e0c185;
      border: 2px solid #e0c185;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      font-family: 'Cinzel Decorative', serif;
      padding: 7px 24px;
      font-size: 1.1em;
      cursor: pointer;
      transition: background .15s, color .15s;
    }
    .gm-tab-btn.active {
      background: #e0c185;
      color: #2c1b1b;
    }
    .gm-table {
      width: 100%;
      border-collapse: collapse;
      background: #200f0f;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
    }
    .gm-table th, .gm-table td {
      border: 1px solid #e0c18566;
      padding: 11px 8px;
      text-align: left;
      font-size: 1em;
    }
    .gm-table th {
      background: #e0c185;
      color: #2c1b1b;
      font-weight: bold;
    }
    .gm-table tr:nth-child(even) {
      background: #241313;
    }
    .cross {
      color: #e06c6c;
      font-size: 1.23em;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.15s;
    }
    .cross:hover { color: #ff2f0a; }
    .msg-info {
      color: #c9b49a;
      font-style: italic;
      margin: 16px 0 0 0;
      text-align: center;
    }
    @media (max-width: 650px) {
      .main-gamemaster {
        max-width: 98vw;
        margin: 10px auto;
        padding: 12px 2vw;
        border-radius: 12px;
      }
      .gm-table th, .gm-table td { padding: 7px 2px; font-size: 1em; }
      .gm-tab-btn { padding: 7px 4vw; font-size: 1em; }
      .gm-btn, .main-btn { padding: 12px 7px; font-size: 0.99em; }
    }
  </style>
</head>
<body>
  <div class="center-wrapper">
    <main class="main-gamemaster" role="main">
      <h1>Gamemaster</h1>
      <h2>Suivi et gestion en temps réel</h2>

      <!-- Section Connexion -->
      <div id="auth-section" class="gm-section">
        <label class="gm-label" for="gm-email">Email du gamemaster</label>
        <input type="email" id="gm-email" class="gm-input" autocomplete="username" required>
        <label class="gm-label" for="gm-password">Mot de passe</label>
        <input type="password" id="gm-password" class="gm-input" autocomplete="current-password" required>
        <button id="gm-login" class="gm-btn">Connexion Gamemaster</button>
        <div id="gm-auth-error" class="gm-error"></div>
      </div>

      <!-- Section Gestion Gamemaster -->
      <div id="gm-content" style="display:none;">
        <div class="gm-tabs">
          <button class="gm-tab-btn active" id="btn-courante" onclick="afficherSuivi()">Partie en cours</button>
          <button class="gm-tab-btn" id="btn-historique" onclick="afficherHistorique()">Historique</button>
        </div>
        <div id="suivi-partie"></div>
        <div id="historique-parties" style="display:none"></div>
      </div>
    </main>
  </div>
  <footer class="footer">
    <p>© 2025 Jeu de piste. Tous droits réservés.</p>
    <a href="mentions-legales.html">Mentions légales</a>
  </footer>

  <!-- Firebase & Logic -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // --- CONFIGURATION FIREBASE ---
    var firebaseConfig = {
      apiKey: "AIzaSyD-BxBu-4ElCqbHrZPM-4-6yf1-yWnL1bI",
      authDomain: "murder-party-ba8d1.firebaseapp.com",
      databaseURL: "https://murder-party-ba8d1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "murder-party-ba8d1",
      storageBucket: "murder-party-ba8d1.appspot.com",
      messagingSenderId: "20295055805",
      appId: "1:20295055805:web:0963719c3f23ab7752fad4",
      measurementId: "G-KSBMBB7KMJ"
    };
    firebase.initializeApp(firebaseConfig);

    // --- AUTHENTIFICATION GAMEMASTER ---
    document.getElementById('gm-login').onclick = function() {
      const email = document.getElementById('gm-email').value;
      const pass = document.getElementById('gm-password').value;
      firebase.auth().signInWithEmailAndPassword(email, pass)
        .then(() => {
          document.getElementById('gm-auth-error').textContent = "";
        })
        .catch(e => {
          document.getElementById('gm-auth-error').textContent = "Connexion échouée : " + e.message;
        });
    };

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        document.getElementById('auth-section').style.display = "none";
        document.getElementById('gm-content').style.display = "block";
        afficherSuivi();
      } else {
        document.getElementById('auth-section').style.display = "block";
        document.getElementById('gm-content').style.display = "none";
      }
    });

    // Gestion des onglets
    function afficherSuivi() {
      document.getElementById('suivi-partie').style.display = 'block';
      document.getElementById('historique-parties').style.display = 'none';
      document.getElementById('btn-courante').classList.add('active');
      document.getElementById('btn-historique').classList.remove('active');
      chargerPartieEnCours();
    }
    function afficherHistorique() {
      document.getElementById('suivi-partie').style.display = 'none';
      document.getElementById('historique-parties').style.display = 'block';
      document.getElementById('btn-courante').classList.remove('active');
      document.getElementById('btn-historique').classList.add('active');
      chargerHistorique();
    }

    // --- Partie en cours (la plus récente) ---
    let partieCouranteId = null;

    function chargerPartieEnCours() {
      const div = document.getElementById('suivi-partie');
      div.innerHTML = "<div class='msg-info'>Chargement en cours...</div>";
      firebase.database().ref("parties").orderByKey().limitToLast(1).once("value").then(snap => {
        if (!snap.exists()) {
          div.innerHTML = "<div class='msg-info'>Aucune partie en cours !</div>";
          return;
        }
        snap.forEach(partieSnap => {
          partieCouranteId = partieSnap.key;
          let data = partieSnap.val();
          let html = `<table class="gm-table">
            <tr>
              <th colspan="3" style="background:#e0c185;color:#2c1b1b;font-size:1.03em;">
                Partie en cours&nbsp;: <span style="font-family:monospace;">${partieCouranteId}</span>
                <button class="gm-btn" style="float:right;margin-top:-5px;" onclick="connecterPartie()">Se connecter</button>
              </th>
            </tr>`;
          if (data.equipes && Object.keys(data.equipes).length > 0) {
            html += `<tr><th>Équipe</th><th>Avancement</th><th></th></tr>`;
            Object.entries(data.equipes).forEach(([eqId, eqData]) => {
              if (eqId !== "0" && eqData) {
                html += `<tr>
                  <td><b>${eqId}</b></td>
                  <td>${eqData.etapeActuelle || 0}</td>
                  <td></td>
                </tr>`;
              }
            });
          } else {
            html += `<tr><td colspan="3"><div class='msg-info'>Aucune équipe enregistrée pour cette partie.</div></td></tr>`;
          }
          html += "</table>";
          div.innerHTML = html;
        });
      }).catch(e => {
        div.innerHTML = "<span style='color:#ff9393'>Erreur lors du chargement : " + e.message + "</span>";
      });
    }

    // --- Connexion à la partie en cours ---
    function connecterPartie() {
      if (!partieCouranteId) {
        alert("Aucune partie en cours !");
        return;
      }
      // Ici tu peux rediriger vers une page de suivi live, ou afficher un panneau de gestion détaillé, etc.
      alert("Connecté à la partie " + partieCouranteId + " ! (code à personnaliser selon ton besoin)");
    }

    // --- Historique ---
    function chargerHistorique() {
      const div = document.getElementById('historique-parties');
      div.innerHTML = "<div class='msg-info'>Chargement en cours...</div>";
      firebase.database().ref("parties").once("value").then(snap => {
        if (!snap.exists()) {
          div.innerHTML = "<div class='msg-info'>Aucune partie enregistrée.</div>";
          return;
        }
        let html = `<table class="gm-table"><tr><th>Partie</th><th>Supprimer</th></tr>`;
        snap.forEach(partieSnap => {
          let partieId = partieSnap.key;
          html += `<tr id="ligne-${partieId}">
            <td>${partieId}</td>
            <td><span class="cross" onclick="supprimerPartie('${partieId}')">❌</span></td>
          </tr>`;
        });
        html += "</table>";
        div.innerHTML = html;
      }).catch(e => {
        div.innerHTML = "<span style='color:#ff9393'>Erreur lors du chargement : " + e.message + "</span>";
      });
    }

    // --- Suppression d'une partie ---
    function supprimerPartie(partieId) {
      if (confirm("Supprimer cette partie ?")) {
        firebase.database().ref("parties/"+partieId).remove().then(() => {
          const ligne = document.getElementById('ligne-'+partieId);
          if (ligne) ligne.remove();
        });
      }
    }
    window.supprimerPartie = supprimerPartie;
    window.connecterPartie = connecterPartie;
  </script>
</body>
</html>
