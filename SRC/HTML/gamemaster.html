<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gamemaster - Jeu de Piste</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- Style amélioré -->
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f6f7fb;
      margin: 0;
      padding: 0;
    }
    h1 {
      background: #2d3e50;
      color: #fff;
      margin: 0;
      padding: 1em 0;
      text-align: center;
      box-shadow: 0 2px 8px #0002;
    }
    #main-container {
      max-width: 900px;
      margin: 2em auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 32px #0001;
      padding: 2em 2em 3em 2em;
    }
    #auth-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1em;
      margin-bottom: 2em;
    }
    #auth-section input {
      padding: 0.5em;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #gm-login {
      padding: 0.6em 1.2em;
      font-size: 1em;
      border-radius: 5px;
      border: none;
      background: #007bff;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    #gm-login:hover {
      background: #0056b3;
    }
    .tabs {
      margin-bottom: 1.5em;
    }
    .tab-btn {
      padding: 0.6em 1.2em;
      margin-right: 1em;
      border: none;
      border-radius: 5px 5px 0 0;
      background: #eee;
      color: #222;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    .tab-btn.active {
      background: #007bff;
      color: #fff;
    }
    .tab-btn:focus { outline: none; }
    #suivi-partie, #historique-parties {
      animation: fadein 0.4s;
    }
    @keyframes fadein {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    .partie-box {
      border: 1px solid #007bff22;
      background: #f9faff;
      border-radius: 7px;
      margin-bottom: 2em;
      padding: 1.3em 2em;
      box-shadow: 0 2px 8px #007bff11;
    }
    .partie-title {
      color: #007bff;
      font-size: 1.2em;
      margin-bottom: 0.2em;
    }
    .btn-connecter {
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 0.5em 1.2em;
      font-weight: bold;
      cursor: pointer;
      margin-left: 1em;
      transition: background 0.2s;
    }
    .btn-connecter:hover {
      background: #217c36;
    }
    .equipe-list {
      margin-top: 1em;
    }
    .equipe-list ul {
      list-style: none;
      padding: 0;
    }
    .equipe-list li {
      background: #e8f1ff;
      border-radius: 5px;
      margin-bottom: 0.5em;
      padding: 0.6em 1em;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1em;
      background: #fbfbfe;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 0.75em 1em;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
    }
    th {
      background: #007bff;
      color: #fff;
    }
    tr:last-child td { border-bottom: none; }
    .cross {
      color: #dc3545;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s;
    }
    .cross:hover {
      color: #b21f2d;
    }
    .msg-info {
      color: #555;
      font-style: italic;
    }
    @media (max-width: 600px) {
      #main-container { padding: 1em; }
      .tab-btn { padding: 0.4em 0.6em; }
      th, td { padding: 0.5em 0.4em; }
    }
  </style>
</head>
<body>
  <h1>Gamemaster : Interface de suivi</h1>
  <div id="main-container">
    <!-- Auth section -->
    <div id="auth-section">
      <input type="email" id="gm-email" placeholder="Email du gamemaster" required>
      <input type="password" id="gm-password" placeholder="Mot de passe" required>
      <button id="gm-login">Connexion Gamemaster</button>
      <div id="gm-auth-error" style="color:red;"></div>
    </div>

    <!-- Contenu réservé au gamemaster -->
    <div id="gm-content" style="display:none;">
      <div class="tabs">
        <button class="tab-btn active" id="btn-courante" onclick="afficherSuivi()">Partie en cours</button>
        <button class="tab-btn" id="btn-historique" onclick="afficherHistorique()">Historique</button>
      </div>
      <!-- Suivi partie en cours -->
      <div id="suivi-partie"></div>
      <!-- Historique -->
      <div id="historique-parties" style="display:none"></div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION FIREBASE ---
    var firebaseConfig = {
      apiKey: "AIzaSyD-BxBu-4ElCqbHrZPM-4-6yf1-yWnL1bI",
      authDomain: "murder-party-ba8d1.firebaseapp.com",
      databaseURL: "https://murder-party-ba8d1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "murder-party-ba8d1",
      storageBucket: "murder-party-ba8d1.appspot.com",
      messagingSenderId: "20295055805",
      appId: "1:20295055805:web:0963719c3f23ab7752fad4",
      measurementId: "G-KSBMBB7KMJ"
    };
    firebase.initializeApp(firebaseConfig);

    // --- AUTHENTIFICATION GAMEMASTER ---
    document.getElementById('gm-login').onclick = function() {
      const email = document.getElementById('gm-email').value;
      const pass = document.getElementById('gm-password').value;
      firebase.auth().signInWithEmailAndPassword(email, pass)
        .then(() => {
          document.getElementById('gm-auth-error').textContent = "";
        })
        .catch(e => {
          document.getElementById('gm-auth-error').textContent = "Connexion échouée : " + e.message;
        });
    };

    // Bloque/débloque l'accès selon l'état d'authentification
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        document.getElementById('auth-section').style.display = "none";
        document.getElementById('gm-content').style.display = "block";
        afficherSuivi(); // Affiche la partie en cours par défaut
      } else {
        document.getElementById('auth-section').style.display = "flex";
        document.getElementById('gm-content').style.display = "none";
      }
    });

    // --- Onglets ---
    function afficherSuivi() {
      document.getElementById('suivi-partie').style.display = 'block';
      document.getElementById('historique-parties').style.display = 'none';
      document.getElementById('btn-courante').classList.add('active');
      document.getElementById('btn-historique').classList.remove('active');
      chargerPartieEnCours();
    }
    function afficherHistorique() {
      document.getElementById('suivi-partie').style.display = 'none';
      document.getElementById('historique-parties').style.display = 'block';
      document.getElementById('btn-courante').classList.remove('active');
      document.getElementById('btn-historique').classList.add('active');
      chargerHistorique();
    }

    // --- Partie en cours (la plus récente, par clé la plus haute) ---
    let partieCouranteId = null;

    function chargerPartieEnCours() {
      const div = document.getElementById('suivi-partie');
      div.innerHTML = "<em>Chargement en cours...</em>";
      firebase.database().ref("parties").orderByKey().limitToLast(1).once("value").then(snap => {
        if (!snap.exists()) {
          div.innerHTML = "<em>Aucune partie en cours !</em>";
          return;
        }
        snap.forEach(partieSnap => {
          partieCouranteId = partieSnap.key;
          let data = partieSnap.val();
          let html = `<div class='partie-box'><div class='partie-title'>Partie en cours : <span style='color:#007bff'>${partieCouranteId}</span>
              <button class='btn-connecter' onclick="connecterPartie()">Se connecter à la partie</button>
            </div>`;
          if (data.equipes && Object.keys(data.equipes).length > 0) {
            html += `<div class='equipe-list'><strong>Équipes :</strong><ul>`;
            Object.entries(data.equipes).forEach(([eqId, eqData]) => {
              if (eqId !== "0" && eqData) {
                html += `<li><strong>Équipe ${eqId}</strong> — Avancement : <b>${eqData.etapeActuelle || 0}</b></li>`;
              }
            });
            html += "</ul></div>";
          } else {
            html += "<div class='msg-info'>Aucune équipe enregistrée pour cette partie.</div>";
          }
          html += "</div>";
          div.innerHTML = html;
        });
      }).catch(e => {
        div.innerHTML = "<span style='color:red'>Erreur lors du chargement : " + e.message + "</span>";
      });
    }

    // Fonction pour "se connecter" à la partie courante (peut être modifiée pour charger le suivi en temps réel, etc.)
    function connecterPartie() {
      if (!partieCouranteId) {
        alert("Aucune partie en cours !");
        return;
      }
      // Ici tu peux charger un affichage plus détaillé, ou activer le suivi en temps réel...
      alert("Connecté à la partie " + partieCouranteId + " ! (à personnaliser selon ton besoin)");
      // Exemple : tu pourrais charger ici le suivi d'étape, les scores en live, etc.
    }

    // --- Historique ---
    function chargerHistorique() {
      const div = document.getElementById('historique-parties');
      div.innerHTML = "<em>Chargement en cours...</em>";
      firebase.database().ref("parties").once("value").then(snap => {
        if (!snap.exists()) {
          div.innerHTML = "<em>Aucune partie enregistrée.</em>";
          return;
        }
        let html = "<h3>Historique des parties</h3><table><tr><th>Partie</th><th>Supprimer</th></tr>";
        snap.forEach(partieSnap => {
          let partieId = partieSnap.key;
          html += `<tr id="ligne-${partieId}">
            <td>${partieId}</td>
            <td><span class="cross" onclick="supprimerPartie('${partieId}')">❌</span></td>
          </tr>`;
        });
        html += "</table>";
        div.innerHTML = html;
      }).catch(e => {
        div.innerHTML = "<span style='color:red'>Erreur lors du chargement : " + e.message + "</span>";
      });
    }

    // --- Suppression d'une partie ---
    function supprimerPartie(partieId) {
      if (confirm("Supprimer cette partie ?")) {
        firebase.database().ref("parties/"+partieId).remove().then(() => {
          const ligne = document.getElementById('ligne-'+partieId);
          if (ligne) ligne.remove();
        });
      }
    }
    // Pour compatibilité globale (onclick inline)
    window.supprimerPartie = supprimerPartie;
    window.connecterPartie = connecterPartie;
  </script>
</body>
</html>
