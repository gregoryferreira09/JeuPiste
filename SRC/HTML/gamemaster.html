<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gamemaster - Suivi des équipes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../Public/styles/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #181212;
      color: #f4e4c1;
      font-family: 'Cormorant Garamond', serif;
    }
    header {
      width: 100vw;
      background: #000;
      color: #e0c185;
      text-align: center;
      font-family: 'Cormorant Garamond', serif;
      padding-top: 22px;
      padding-bottom: 22px;
      box-sizing: border-box;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .site-title {
      margin: 0;
      font-family: 'Cinzel Decorative', serif;
      font-size: 2.1em;
      color: #e0c185;
      letter-spacing: 1.5px;
    }
    .gm-wrapper {
      flex: 1 0 auto;
      max-width: 900px;
      margin: 38px auto 0 auto;
      background: #2c1b1b;
      border-radius: 20px;
      box-shadow: 0 4px 24px #0004;
      border: 2px solid #e0c185;
      padding: 32px 18px 22px 18px;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .carousel {
      display: flex;
      align-items: stretch;
      justify-content: center;
      gap: 18px;
    }
    .nav-btn {
      background: linear-gradient(90deg, #e0c185, #ffeecb 60%);
      color: #473714;
      font-size: 2em;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      box-shadow: 0 2px 14px #0002;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background .17s, color .17s, box-shadow .17s;
      margin: 0;
    }
    .nav-btn:focus, .nav-btn:hover {
      background: #ffeecb;
      color: #181212;
      box-shadow: 0 0 8px #e0c185a8;
      outline: 2px solid #e0c185;
      outline-offset: 2px;
      transform: scale(1.05);
    }
    .carte-equipe {
      flex: 1;
      background: #231d1d;
      border-radius: 16px;
      border: 2px solid #e0c185;
      box-shadow: 0 2px 14px #0003;
      padding: 32px 22px 18px 22px;
      min-height: 280px;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .team-title {
      font-size:1.23em;
      color:#ffeecb;
      margin-bottom:8px;
      font-family: 'Cinzel Decorative', serif;
      font-weight: 600;
      letter-spacing: 1px;
      text-align: center;
    }
    .team-members {
      font-size:1.07em;
      color:#e0c185;
      margin-bottom:14px;
      text-align: center;
    }
    .etape-encours {
      margin: 10px 0 5px 0;
      font-weight: bold;
      font-size: 1.09em;
      letter-spacing: 1px;
      color: #ffe07e;
      text-align: center;
    }
    .timer {
      font-size: 1.14em;
      margin-bottom: 10px;
      background: #181212;
      border-radius: 9px;
      padding: 7px 20px;
      color: #e0c185;
      font-family: 'Roboto Mono', monospace;
      letter-spacing: 1px;
      box-shadow: 0 1px 6px #0002;
      text-align: center;
      display: inline-block;
    }
    .timer.late { color: #ff2f2f; background: #2b1313; }
    .parcours-list {
      margin-top: 16px;
    }
    .epreuve {
      margin-bottom: 16px;
      padding-bottom: 5px;
      border-bottom: 1px solid #3a2c1d44;
    }
    .epreuve-titre {
      font-weight: bold;
      color: #e0c185;
      font-size: 1.06em;
      letter-spacing: .5px;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .step-status.done { color: #4caf50; font-weight: bold; }
    .step-status.current { color: #ffe07e; font-weight: bold; }
    .step-status.todo { color: #ccc; }
    .validate-btn, .invalidate-btn {
      background: #e0c185;
      color: #473714;
      border: none;
      border-radius: 6px;
      padding: 2px 12px;
      margin-left: 8px;
      font-size: .96em;
      font-family: inherit;
      cursor: pointer;
      transition: background 0.18s;
    }
    .invalidate-btn { background: #e55b5b; color: #fff; }
    .validate-btn:hover { background: #ffeecb; }
    .invalidate-btn:hover { background: #ffadad; }
    .fichiers-epreuve {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }
    .miniature, .miniature-video {
      max-width: 72px;
      max-height: 60px;
      border-radius: 6px;
      border: 1.5px solid #bfa87c;
      background: #181212;
      box-shadow: 0 1px 5px #0002;
      transition: border .2s, box-shadow .2s;
    }
    .miniature:hover, .miniature-video:hover {
      border: 2px solid #ffe07e;
      box-shadow: 0 4px 10px #ffe07e33;
    }
    .fichier-bloc {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 2px;
      background: #261b10bb;
      border-radius: 5px;
      padding: 3px 6px 3px 4px;
      font-size: .97em;
    }
    .download-btn {
      color: #e0c185;
      text-decoration: underline;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 0.98em;
      padding: 0 3px;
      margin-left: 5px;
      border-radius: 3px;
      transition: background .2s, color .2s;
    }
    .download-btn:hover {
      background: #ffe07e;
      color: #1a1a1a;
    }
    .history-list {
      font-size: .98em;
      color: #ffe07e;
      margin-top: 13px;
      word-break: break-all;
      min-height: 22px;
    }
    .error-message { color: #ff7777; font-weight: bold; margin: 13px 0; }
    footer, .footer {
      flex-shrink: 0;
      width: 100vw;
      background: #000;
      color: #e0c185;
      text-align: center;
      font-family: 'Cormorant Garamond', serif;
      padding-top: 22px;
      padding-bottom: 22px;
      box-sizing: border-box;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      position: relative;
      left: 0;
      right: 0;
      bottom: 0;
      margin: 0;
      border: none;
    }
    @media (max-width: 900px) {
      .gm-wrapper { max-width: 99vw; }
      .carte-equipe { padding: 8px 3vw;}
    }
    @media (max-width: 700px) {
      .gm-wrapper { padding: 2px; }
      .carte-equipe { padding: 8px 2vw;}
      .miniature, .miniature-video { max-width: 42px; max-height: 28px;}
      .nav-btn { width: 34px; height: 34px; font-size: 1.3em; }
      .site-title { font-size: 1.3em; padding: 17px 0 12px 0;}
    }
  </style>
</head>
<body>
  <header>
    <h1 class="site-title">Gamemaster — Suivi des équipes</h1>
  </header>
  <div class="gm-wrapper">
    <div class="carousel">
      <button class="nav-btn" id="prev-team" aria-label="Équipe précédente">&#8592;</button>
      <div class="carte-equipe" id="carte-equipe">
        <div style="text-align:center;">Chargement…</div>
      </div>
      <button class="nav-btn" id="next-team" aria-label="Équipe suivante">&#8594;</button>
    </div>
  </div>
  <footer class="footer">
    <p>© 2025 Jeu de piste. Tous droits réservés.</p>
    <a href="mentions-legales.html">Mentions légales</a>
  </footer>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    // --- CONFIG & INIT ---
    const firebaseConfig = {
      apiKey: "AIzaSyD-BxBu-4ElCqbHrZPM-4-6yf1-yWnL1bI",
      authDomain: "murder-party-ba8d1.firebaseapp.com",
      databaseURL: "https://murder-party-ba8d1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "murder-party-ba8d1",
      storageBucket: "murder-party-ba8d1.appspot.com",
      messagingSenderId: "20295055805",
      appId: "1:20295055805:web:0963719c3f23ab7752fad4",
      measurementId: "G-KSBMBB7KMJ"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const salonCode = localStorage.getItem("salonCode") || prompt("Code salon à superviser ?");
    let equipes = [];
    let nomsEquipes = {};
    let currentIndex = 0;
    let parcoursEquipes = []; // pour chaque équipe
    let cheminsParEquipe = {}; // mapping équipe => index parcours
    let timerInterval = null;
    let equipeStepListener = null;

    document.getElementById('prev-team').onclick = function() {
      if (equipes.length) {
        currentIndex = (currentIndex - 1 + equipes.length) % equipes.length;
        afficherEquipe();
      }
    };
    document.getElementById('next-team').onclick = function() {
      if (equipes.length) {
        currentIndex = (currentIndex + 1) % equipes.length;
        afficherEquipe();
      }
    };

    // Rafraîchissement auto et synchro dynamique sur currentStep
    function chargerEquipes(callback) {
      db.ref(`parties/${salonCode}/cheminsParEquipe`).once('value', snapChemins => {
        cheminsParEquipe = snapChemins.val() || {};
        db.ref(`parties/${salonCode}/parcoursEquipes`).once('value', snapParcours => {
          parcoursEquipes = snapParcours.val() || [];
          db.ref(`parties/${salonCode}/equipes`).once('value', snap => {
            const data = snap.val() || {};
            equipes = Object.entries(data).map(([num, eq]) => ({...eq, num}));
            db.ref(`parties/${salonCode}/nomsEquipes`).once('value', snapNoms => {
              nomsEquipes = snapNoms.val() || {};
              if (equipes.length === 0) {
                document.getElementById('carte-equipe').innerHTML = "<div style='text-align:center;'>Aucune équipe détectée</div>";
              } else {
                if (currentIndex >= equipes.length) currentIndex = 0;
                if (callback) callback();
                else afficherEquipe();
              }
            });
          });
        });
      });
    }

    // Donne le vrai parcours d'une équipe selon la config
    function getParcoursEquipe(equipeNum) {
      if (!cheminsParEquipe || !parcoursEquipes || !parcoursEquipes.length) return [];
      const idx = cheminsParEquipe[equipeNum];
      return parcoursEquipes[idx] || [];
    }

    function afficherEquipe() {
      if (equipeStepListener) equipeStepListener.off();
      const carte = document.getElementById('carte-equipe');
      const equipe = equipes[currentIndex];
      const parcours = getParcoursEquipe(equipe.num);
      const totalEtapes = parcours ? parcours.length : 0;

      // Synchronise dynamiquement sur le currentStep de l'équipe
      equipeStepListener = db.ref(`parties/${salonCode}/equipes/${equipe.num}/currentStep`);
      equipeStepListener.on('value', function(snapshot) {
        const step = snapshot.val() ?? 0;
        const etapeCourante = (step < totalEtapes) ? (step + 1) : totalEtapes;
        let html = `
          <div class='team-title'>${nomsEquipes[equipe.num] || `Équipe ${parseInt(equipe.num)+1}`}</div>
          <div class='team-members'>${equipe.membres ? Object.values(equipe.membres).map(m=>m.pseudo).join(', ') : '—'}</div>
          <div class='etape-encours'>Étape ${etapeCourante} / ${totalEtapes}</div>
          <div id="timer" class="timer">Temps sur cette épreuve : <span id="timer-inner">—</span></div>
          <div class='parcours-list'>
        `;
        for (let i=0; i<totalEtapes; i++) {
          html += `<div class='epreuve'>
            <div class='epreuve-titre'>
              Épreuve ${parcours[i]}
              <span class="step-status ${i < step ? 'done' : (i === step ? 'current' : 'todo')}">
                ${i < step ? "✔️" : (i === step ? "🟡" : "—")}
              </span>
              ${i === step && i < totalEtapes ? `<button class="validate-btn" onclick="validerEtape(${equipe.num},${i})" aria-label="Valider cette étape">Valider</button>
              <button class="invalidate-btn" onclick="invaliderEtape(${equipe.num},${i})" aria-label="Invalider cette étape">Invalider</button>` : ""}
            </div>
            <div class='fichiers-epreuve' id='fichiers-eq${equipe.num}-etape${i}'><span style='color:#b8b8b8;'>Chargement fichiers…</span></div>
          </div>`;
        }
        html += `</div>`;
        html += `<div class="history-list" id="history-eq${equipe.num}"></div>`;
        carte.innerHTML = html;
        afficherTimer(equipe, step, totalEtapes);
        for (let i=0; i<totalEtapes; i++) {
          listerFichiersEquipeEtape(equipe.num, parcours[i], i);
        }
        afficherHistorique(equipe.num);
      });
    }

    function afficherTimer(equipe, step, totalEtapes) {
      if (timerInterval) clearInterval(timerInterval);
      const timerDiv = document.getElementById('timer-inner');
      if (!timerDiv || step >= totalEtapes) {
        if (timerDiv) timerDiv.textContent = "—";
        return;
      }
      db.ref(`parties/${salonCode}/equipes/${equipe.num}/etapes/${step}/debut`).once('value', snap => {
        const start = snap.val();
        if (!start) {
          timerDiv.textContent = "Non démarré";
          return;
        }
        function maj() {
          const elapsed = Math.floor((Date.now() - start) / 1000);
          const min = Math.floor(elapsed/60), sec = elapsed%60;
          timerDiv.textContent = `${min}:${sec.toString().padStart(2,'0')}`;
          if (elapsed >= 600) timerDiv.parentNode.classList.add('late');
          else timerDiv.parentNode.classList.remove('late');
        }
        maj();
        timerInterval = setInterval(maj, 1000);
      });
    }

    function listerFichiersEquipeEtape(num, epreuveNum, etapeIdx) {
      const div = document.getElementById(`fichiers-eq${num}-etape${etapeIdx}`);
      if (!div) return;
      const basePath = `parties/${salonCode}/equipes/${num}/epreuves/${epreuveNum}`;
      storage.ref(basePath).listAll().then(res => {
        if (res.items.length === 0) {
          div.innerHTML = `<span style="color:#b8b8b8;">Aucun fichier envoyé</span>`;
        } else {
          div.innerHTML = '';
          res.items.forEach(fichier => {
            fichier.getDownloadURL().then(url => {
              const ext = fichier.name.split('.').pop().toLowerCase();
              let mini = '';
              if(['jpg','jpeg','png','gif'].includes(ext)) {
                mini = `<img src="${url}" class="miniature" alt="Photo">`;
              } else if(['mp4','webm','ogg'].includes(ext)) {
                mini = `<video src="${url}" class="miniature-video" muted preload="metadata" controls></video>`;
              }
              div.innerHTML += `<div class="fichier-bloc">${mini}<span>${fichier.name}</span>
                <button class="download-btn" onclick="downloadFile('${url}','${fichier.name}')">Télécharger</button>
                <a href="${url}" target="_blank" class="download-btn" style="text-decoration:none;">Voir</a>
              </div>`;
            });
          });
        }
      }).catch(()=>{div.innerHTML = "<span class='error-message'>Erreur de récupération fichiers !</span>";});
    }

    window.validerEtape = function(num, etapeIdx) {
      if (!confirm("Valider cette étape ?")) return;
      db.ref(`parties/${salonCode}/equipes/${num}/currentStep`).transaction(step => {
        if (step == null || etapeIdx >= step) return etapeIdx + 1;
        return step;
      }, function(error, committed, snapshot) {
        if (committed) { chargerEquipes(); }
        else alert("Erreur validation.");
      });
      const time = new Date().toLocaleString();
      db.ref(`parties/${salonCode}/equipes/${num}/historique`).push({ action: "Validation manuelle", etape: etapeIdx, when: time });
    };
    window.invaliderEtape = function(num, etapeIdx) {
      if (!confirm("Invalider/retourner à cette étape ?")) return;
      db.ref(`parties/${salonCode}/equipes/${num}/currentStep`).set(etapeIdx);
      const time = new Date().toLocaleString();
      db.ref(`parties/${salonCode}/equipes/${num}/historique`).push({ action: "Retour étape", etape: etapeIdx, when: time });
      chargerEquipes();
    };

    function afficherHistorique(num) {
      const histDiv = document.getElementById('history-eq'+num);
      db.ref(`parties/${salonCode}/equipes/${num}/historique`).once('value', snap => {
        const hist = [];
        snap.forEach(child => {
          const h = child.val();
          hist.push(`<li>${h.when || ''} — ${h.action}${h.etape != null ? ' (étape '+(Number(h.etape)+1)+')' : ''}</li>`);
        });
        if (hist.length === 0) {
          histDiv.innerHTML = `<span style="color:#b8b8b8;">Aucun évènement</span>`;
        } else {
          histDiv.innerHTML = `<ul>${hist.join('')}</ul>`;
        }
      });
    }

    window.downloadFile = function(url, fileName) {
      fetch(url)
        .then(resp => resp.blob())
        .then(blob => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
          }, 100);
        });
    };

    // Rafraîchissement auto de la liste des équipes (rafraîchit aussi navigation, membres, etc)
    function refreshLoop() {
      chargerEquipes();
      setTimeout(refreshLoop, 5000);
    }
    refreshLoop();

  </script>
</body>
</html>
