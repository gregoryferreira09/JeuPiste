<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Salon de la Partie – Jeu de piste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../Public/styles/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative&family=Cormorant+Garamond&display=swap" rel="stylesheet">
  <style>
    /* ... (tes styles inchangés) ... */
    #loader { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(24,18,18,0.35); z-index: 99999; justify-content: center; align-items: center;}
    .spinner { border: 4px solid #eee; border-top: 4px solid #e0c185; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;}
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-toast { display: none; position: fixed; left: 50%; top: 12%; transform: translateX(-50%); background: #231d1d; color: #ffeecb; border: 2px solid #e0c185; border-radius: 8px; padding: 16px 28px; font-size: 1.14em; z-index: 99999; box-shadow: 0 4px 22px #0006; text-align:center; max-width: 90vw;}
    .modal-toast.visible { display: block; animation: fadein 0.3s;}
    @keyframes fadein { from { opacity: 0; } to { opacity: 1; }}
  </style>
</head>
<body class="accueil">
  <div id="loader" aria-live="polite"><div class="spinner"></div></div>
  <div class="modal-toast" id="toast-message" role="alert" aria-live="assertive"></div>
  <header>
    <h1 class="site-title">Jeu de piste</h1>
  </header>
  <div class="center-wrapper">
    <main class="main-accueil fadeIn" role="main">
      <h1>Salon de la partie</h1>
      <div class="bienvenue-message">
        Bonjour <span id="pseudoAffiche"></span>
      </div>
      <div>
        <p class="texte-x2">Partagez ce code avec les autres joueurs :</p>
        <div class="code code-x2" id="codeSalon">------</div>
        <div class="status" id="etatSalon">En attente de joueurs...</div>
        <div class="salon-colonne">
          <ul id="listeJoueurs"></ul>
          <div class="boutons-actions">
            <button class="main-btn" id="cloturerSalonBtn" style="display:none;">Clôturer le salon</button>
            <button class="main-btn" id="quitterSalonBtn" style="display:none;">Quitter le salon</button>
          </div>
        </div>
        <div id="alertSalonSupprime" style="display:none; color:#ff6b6b; margin-top:10px; text-align:center; font-weight:bold;">
          Salon supprimé par le créateur.
        </div>
      </div>
      <!-- Modale confirmation harmonisée -->
      <div id="confirmationModal" role="dialog" aria-modal="true" aria-labelledby="modalQuestion">
        <div class="main-accueil">
          <div class="modal-question" id="modalQuestion"></div>
          <div class="boutons-actions">
            <button id="confirmModalBtn" class="main-btn">Oui</button>
            <button id="cancelModalBtn" class="main-btn">Non</button>
          </div>
        </div>
      </div>
    </main>
  </div>
  <footer class="footer">
    <p>© 2025 Jeu de piste. Tous droits réservés.</p>
    <a href="mentions-legales.html">Mentions légales</a>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script>
    // CONFIG FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyD-BxBu-4ElCqbHrZPM-4-6yf1-yWnL1bI",
      authDomain: "murder-party-ba8d1.firebaseapp.com",
      databaseURL: "https://murder-party-ba8d1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "murder-party-ba8d1",
      storageBucket: "murder-party-ba8d1.firebasestorage.app",
      messagingSenderId: "20295055805",
      appId: "1:20295055805:web:0963719c3f23ab7752fad4",
      measurementId: "G-KSBMBB7KMJ"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Loader & Toast
    function showLoader() { document.getElementById('loader').style.display = 'flex'; }
    function hideLoader() { document.getElementById('loader').style.display = 'none'; }
    function showToast(msg) {
      const toast = document.getElementById('toast-message');
      toast.textContent = msg;
      toast.classList.add('visible');
      setTimeout(() => { toast.classList.remove('visible'); }, 2700);
    }

    // SECURISATION NAVIGATION (par currentStep)
    document.addEventListener("DOMContentLoaded", function() {
      showLoader();
      const salonCode = localStorage.getItem("salonCode");
      const equipeNum = Number(localStorage.getItem("equipeNum"));
      if (!salonCode) {
        hideLoader();
        window.location.replace("creer-partie.html");
        return;
      }
      // On ne bloque l'accès que si currentStep > 0 (sinon salon accessible)
      db.ref('parties/' + salonCode + '/equipes/' + equipeNum + '/currentStep').on('value', function(snapshot) {
        hideLoader();
        const step = snapshot.val();
        if (step !== undefined && step !== null && step > 0) {
          // Redirection automatique vers la bonne étape
          db.ref('parties/' + salonCode + '/cheminsParEquipe/' + equipeNum).once('value', function(snapIdx) {
            const parcoursIdx = snapIdx.val();
            db.ref('parties/' + salonCode + '/parcoursEquipes/' + parcoursIdx).once('value', function(snapParcours) {
              const parcours = snapParcours.val() || [1,2,3,4,5];
              const target = parcours[step-1];
              if (target === 6) window.location.href = "epreuve6.html";
              else if (target === 7) window.location.href = "révélation.html";
              else window.location.href = `equipe${target}-a.html`;
            });
          });
        }
        // Si step == 0, on reste dans le salon
      });

      // (Remets ici tout ton JS salon EXISTANT pour la logique de génération/affichage du code, gestion joueurs, boutons, etc.)
      // Rien n'est supprimé ni remplacé dans ta logique d'avant !
    });

    // Optionnel : anti-retour arrière
    window.addEventListener("pageshow", function(evt) {
      if (evt.persisted) location.reload();
    });
  </script>
  <!-- Remets ici tout ton JS salon ORIGINAL (génération code, gestion boutons, joueurs, etc.) -->

  <script>
    // Remets ici (ou dans un fichier séparé) tout ton JS salon original qui gérait :
    // - la génération du code salon
    // - l'affichage de la liste des joueurs
    // - la gestion des boutons créateur/joueur
    // - le lancement automatique, etc.
    //
    // Rien ne doit être supprimé : tu ajoutes juste le bloc "securisation navigation" ci-dessus en plus.
  </script>

  <script src="../JS/security-enhance.js"></script>
  <script src="../JS/ux-enhance.js"></script>
  <script src="../JS/scalability.js"></script>
</body>
</html>
